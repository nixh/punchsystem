(function(n,H,A){function B(d,b){function f(x){x=new I(x,b);x.b.insertBefore(k);x.b.css("maxWidth",a.c.width());a.a.push(x);B&&k.val("");t(!0);m.hide();e||k.focus();g()}function p(e,b){e.remove();var c=a.a.indexOf(e);a.a.splice(c,1);e===q&&(q=A);g();t(!0);b&&(-1===b?h(a.a[c-1]):1===b&&h(a.a[c]));s()}function g(){for(var e=[],k=0;k<a.a.length;k+=1)e.push(a.a[k].value);c.val(e.join(b.delimiter));c.trigger("change")}function h(a){q&&q.e();q!==a?(q=a,a.select()):q=A}function u(){q&&(q.e(),q=A)}function v(){var a=
b.searchIn;"string"==typeof a&&(a=[a]);if(n.isArray(a)){for(var e={},c=0;c<a.length;c+=1)e[a[c]]=10;return e}return a}function l(e){for(var c=0;c<a.a.length;c+=1)if(a.a[c].item===e)return!0;return!1}function s(){var e=b.items,c=[],f=k.val(),d=v();a.c.removeClass("invalid");if(a.a.length===b.maxItems)m.hide(),k.removeAttr("placeholder");else if(k.attr("placeholder",F),""!==f||b.autoShow){if(""!==f){for(var r=0;r<e.length;r+=1){var g={item:e[r],i:J(e[r],f,d)};0<g.i&&(b.allowDuplicates||!l(g.item))&&
c.push(g)}c=c.sort(function(a,e){return e.i-a.i});for(r=0;r<c.length;r+=1)c[r]=c[r].item}else for(r=0;r<e.length;r+=1)!b.allowDuplicates&&l(e[r])||c.push(e[r]);m.q(c);m.p(f);m.l(w)}else m.hide()}function t(e){if(a.k!=k.val()||!0===e)a.c.toggleClass("full",a.a.length===b.maxItems),u(),a.k=k.val(),G.text(a.k),k.width(0),k.width(Math.min(a.c.width()-5,Math.max(a.c.width()-k.offset().left+a.c.offset().left+5,G.width(),1))),m.l(w)}var a=this;a.a=[];var e=!0;document.activeElement===d&&(e=!1);var c=a.input=
n(d).hide();a.options=b;var w=a.c=n('<div class="tagbox-wrapper" />').click(function(a){var e=n(a.target).closest("input, .tagbox-token, .tagbox-wrapper");e.is(".tagbox-token")?n(a.target).is("a")?p(e.data("token")):h(e.data("token")):u();k.focus()}).insertBefore(a.input);b.className&&w.addClass(b.className);c.on("invalid",function(e){e.preventDefault();a.c.addClass("invalid")});var F=c.attr("placeholder"),k=n('<input type="text" />').attr({autocomplete:c.attr("autocomplete"),spellcheck:c.attr("spellcheck"),
autocapitalize:c.attr("autocapitalize"),placeholder:F}).on("keyup keydown blur update change",t).on("keypress",function(a){if(13===a.keyCode&&k.val())return a.preventDefault(),!1}).on("blur",function(){setTimeout(function(){a.f||m.hide();w.removeClass("focus")},50);c.triggerHandler("blur")}).on("keydown",function(e){var c=k.val().length==k[0].selectionStart,w=0===k[0].selectionEnd,d=e.keyCode,g=!1;if(e.ctrlKey||e.metaKey)g=!0;if(37===d){if(q)return q===a.a[0]?u():h(a.a[a.a.indexOf(q)-1]),g;w&&a.a.length&&
h(a.a[a.a.length-1])}if(39===d){if(q)return q===a.a[a.a.length-1]?u():h(a.a[a.a.indexOf(q)+1]),g;c&&a.a.length&&h(a.a[0])}if(q&&(46===d||8===d))return p(q,8===d?-1:1),g;if(8===d&&w&&a.a.length)return h(a.a[a.a.length-1]),g;if(m.visible){if(38===d)return m.o(),g;if(40===d)return m.n(),g;if(39==d&&c||13==d||9==d)return m.visible&&((e=m.m())?f(e):b.allowNew&&k.val()&&f(b.createNew(k.val()))),g}else if(k.val()&&13==d)return g;if(a.a.length===b.maxItems&&9!=e.keyCode)return k.val(""),g;setTimeout(s,10)}).on("focus",
function(){w.addClass("focus");c.triggerHandler("focus");s()}).appendTo(w),G=n("<span />").appendTo(w).css({position:"absolute",left:-1E5,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),fontWeight:c.css("fontWeight"),fontVariant:c.css("fontVariant"),letterSpacing:c.css("letterSpacing")}),m=a.r=new K(a,b);m.b.appendTo(b.dropdownContainer);if(c.val())for(var C=b.items,D=c.val().split(b.delimiter),E,y=0;y<D.length;y+=1){E=!1;for(var z=
0;z<C.length;z+=1)if(C[z][b.valueField]==D[y]){f(C[z]);E=!0;break}!E&&b.allowNew&&f(b.createNew(D[y]))}var B=!0;t(!0);n(H).on("resize",function(){t(!0)});setTimeout(function(){t(!0)},500);a.j=f;var q,e=!1}function I(d,b){var f=this,p=f.b=n('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",f),g=b.tokenFormat;f.value="string"==typeof d?d:d[b.valueField];f.item=d;"string"==typeof g?("string"==typeof d&&(d={value:d}),p.children("span").html(g.replace(/\{\{([^}]*)\}\}/g,function(b,
f){return d[f]}))):p.children("span").html(g(d));f.remove=function(){p.data("token",null);p.remove();f.item=null;f.b=null};f.select=function(){p.addClass("selected")};f.e=function(){p.removeClass("selected")}}function K(d,b){function f(a,e){h&&h.e();s&&s.removeClass("selected");"number"!==typeof a&&(a=v.indexOf(a));0<=a?(h=v[a],h.select(),clearTimeout(t),e?t=setTimeout(function(){p(h.b)},80):p(h.b)):(h=!1,s&&s.addClass("selected"));u=a}function p(a){var e=a.offset().top-l.offset().top;0>e?l.scrollTop(e+
l.scrollTop()):e>l.innerHeight()-a.outerHeight()&&l.scrollTop(e+l.scrollTop()-l.innerHeight()+a.outerHeight())}var g=this,h,u,v,l=g.b=n('<div class="tagbox-dropdown"><div class="tagbox-list"></div></div>').css({maxHeight:b.maxHeight}).hide();if(b.allowNew)var s=n('<div class="tagbox-item new-item" />').prependTo(l).on("mousedown",function(){d.f=!0}).on("mouseup",function(){d.f=!1}).on("click",function(){d.j(b.createNew(g.h))});g.l=function(a){l.offset();var e=a.offset(),c=l.parent().offset();l.parent().is("body")&&
(c={top:0,left:0});l.css({top:e.top-c.top+a.height()+1,left:e.left-c.left,width:a.outerWidth()})};g.show=function(){l.show();g.visible=!0};g.hide=function(){l.hide();g.visible=!1};g.m=function(){if(h)return h.item};g.n=function(){u===v.length-1?b.allowNew&&g.h||0===v.length?f(-1):f(0):f(u+1)};g.o=function(){0===u?b.allowNew&&g.h?f(-1):f(v.length-1):(-1===u&&(u=v.length),f(u-1))};var t;g.p=function(a){s&&((g.h=a)?s.show().text(b.newText.replace(/\{\{txt\}\}/g,a)):s.hide())};g.q=function(a){l.find(".tagbox-list").empty();
v=[];if(0<a.length){for(var e=0;e<Math.min(a.length,b.maxListItems);e+=1){var c=new L(a[e],b);c.b.appendTo(l.find(".tagbox-list"));c.b.on("mouseover",function(a){return function(){f(a,!0)}}(c));c.b.on("mousedown",function(){d.f=!0}).on("mouseup",function(){d.f=!1});c.b.on("click",function(a){return function(){d.j(a)}}(a[e]));v.push(c)}f(0)}else b.allowNew||n('<div class="tagbox-item empty"/>').text(b.emptyText).appendTo(l.find(".tagbox-list")),f(-1);g.show()}}function L(d,b){var f=this.b=n('<div class="tagbox-item" />');
b.itemClass&&f.addClass(b.itemClass);this.item=d;var p=b.rowFormat;"string"==typeof p?("string"==typeof d&&(d={value:d}),f.html(p.replace(/\{\{([^}]*)\}\}/g,function(b,f){return d[f]}))):f.html(p(d));this.select=function(){f.addClass("selected")};this.e=function(){f.removeClass("selected")}}var J=function(){function d(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function b(a){return/[a-z]/.test(a)?n:/[A-Z]/.test(a)?h:/[0-9]/.test(a)?v:/[\/\-_\.]/.test(a)?l:s}function f(a,
c,f){a=b(a);return t[a][b(c)]+0.4*t[a][b(f)]}function p(a,c,b){if(0===c.length)return 100*b/a.length;if(0===a.length||!a.slice(b).match(RegExp(("^.*"+d(c.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var g=c.charAt(0),k=-1,l;b<a.length;b+=1)if(a.charAt(b).toLowerCase()===g.toLowerCase()){var m=p(a.substr(b),c.slice(1),1);if(-1!=m){var h=400/Math.max(1,b);0===a.substr(b).toLowerCase().indexOf(c.toLowerCase())&&(h+=3*c.length*c.length);h+=f(a.charAt(b),0===b?"/":a.charAt(b-
1),b===a.length-1?"/":a.charAt(b+1));h+=m;if(h>k)for(k=h,l=[b],m=m.g||[],h=0;h<m.length;h+=1)l.push(m[h]+b)}}return{d:k,valueOf:function(){return this.d},g:l}}function g(b,c){return p(a(b),a(c),0)}var h=0,n=1,v=2,l=3,s=4,t=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],a=function(a,b){var f=RegExp("["+a+"]","g"),d={},g;lookup=function(a){return d[a]||a};for(g=0;g<a.length;g+=1)d[a.charAt(g)]=b.charAt(g);return function(a){return a.replace(f,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd",
"aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(a,b,f){if("string"==typeof a)return g(a,b);var d={d:0,valueOf:function(){return this.d},g:{}},k;for(k in f)if(f.hasOwnProperty(k)&&a.hasOwnProperty(k)){var h=g(a[k],b);d.d+=f[k]*h;d.g[k]=0<h?h.g:[]}return d}}();n.fn.tagbox=function(d){var b=n.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{value}}",tokenFormat:"{{value}}",valueField:"value",searchIn:["value"],delimiter:",",allowDuplicates:!1,createNew:function(b){return{value:b}},
allowNew:!1,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:!1},d);return this.each(function(){if(!n(this).data("tagbox")){var d=new B(this,b);n(this).data("tagbox",d)}})}})(jQuery,window);
